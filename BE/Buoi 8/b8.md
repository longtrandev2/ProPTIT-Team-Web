# [KHÃ“A SPRING BOOT CÆ  Báº¢N]
# [BUá»”I 4] Thao tÃ¡c vá»›i DATABASE
# Ná»™i dung cáº§n chuáº©n bá»‹
# CÃ¡c má»‘i quan há»‡(1..N, N..N) trong JPA (@ManyToMany, @OneToMany,...)

# CÃ¡c Loáº¡i Má»‘i Quan Há»‡ Trong JPA

## 1\. Má»‘i Quan Há»‡ One-to-One (Má»™t-Ä‘á»‘i-Má»™t)

Má»‘i quan há»‡ **One-to-One** xáº£y ra khi má»™t thá»±c thá»ƒ A Ä‘Æ°á»£c liÃªn káº¿t vá»›i **duy nháº¥t má»™t** thá»±c thá»ƒ B, vÃ  ngÆ°á»£c láº¡i, thá»±c thá»ƒ B cÅ©ng chá»‰ Ä‘Æ°á»£c liÃªn káº¿t vá»›i **duy nháº¥t má»™t** thá»±c thá»ƒ A. VÃ­ dá»¥ Ä‘iá»ƒn hÃ¬nh lÃ  má»‘i quan há»‡ giá»¯a má»™t ngÆ°á»i vÃ  sá»‘ cÄƒn cÆ°á»›c cÃ´ng dÃ¢n cá»§a há», hoáº·c má»™t nhÃ¢n viÃªn vÃ  thÃ´ng tin chi tiáº¿t vá» lÆ°Æ¡ng cá»§a há» (náº¿u tÃ¡ch riÃªng).

Äá»ƒ mÃ´ hÃ¬nh hÃ³a má»‘i quan há»‡ One-to-One trong JPA, chÃºng ta sá»­ dá»¥ng annotation **`@OneToOne`**. Má»™t trong hai thá»±c thá»ƒ sáº½ lÃ  **â€œowning sideâ€ (bÃªn sá»Ÿ há»¯u)**, nÆ¡i khÃ³a ngoáº¡i thá»±c sá»± tá»“n táº¡i trong báº£ng CSDL. BÃªn cÃ²n láº¡i sáº½ lÃ  **â€œinverse sideâ€ (bÃªn Ä‘áº£o ngÆ°á»£c)** vÃ  sá»­ dá»¥ng thuá»™c tÃ­nh **`mappedBy`** Ä‘á»ƒ chá»‰ ra trÆ°á»ng nÃ o á»Ÿ bÃªn sá»Ÿ há»¯u Ä‘á»‹nh nghÄ©a má»‘i quan há»‡ nÃ y.

### VÃ­ Dá»¥: NgÆ°á»i vÃ  ThÃ´ng Tin Chi Tiáº¿t

Giáº£ sá»­ chÃºng ta cÃ³ hai thá»±c thá»ƒ: `Nguoi` (Person) vÃ  `ThongTinChiTiet` (Detail Information). Má»—i ngÆ°á»i cÃ³ má»™t bá»™ thÃ´ng tin chi tiáº¿t duy nháº¥t.

```java
@Entity
public class Nguoi {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    private String ten;

    // Owning side: Nguoi holds the foreign key to ThongTinChiTiet
    @OneToOne(cascade = CascadeType.ALL) // cascade = ALL means save/delete Nguoi will cascade to ThongTinChiTiet
    @JoinColumn(name = "thong_tin_chi_tiet_id", referencedColumnName = "id") // Specifies the FK column
    private ThongTinChiTiet thongTinChiTiet;

    // Getters and Setters...
}

@Entity
public class ThongTinChiTiet {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    private String diaChi;
    private String soDienThoai;

    // Inverse side: Uses mappedBy to reference the field in the owning side
    @OneToOne(mappedBy = "thongTinChiTiet")
    private Nguoi nguoi;

    // Getters and Setters...
}
```

**Trong vÃ­ dá»¥ nÃ y:**

  * **`Nguoi`** lÃ  **bÃªn sá»Ÿ há»¯u (owning side)**. Annotation **`@JoinColumn(name = "thong_tin_chi_tiet_id", referencedColumnName = "id")`** chá»‰ ra ráº±ng báº£ng `nguoi` trong CSDL sáº½ cÃ³ má»™t cá»™t tÃªn lÃ  `thong_tin_chi_tiet_id`, Ä‘Ã¢y lÃ  khÃ³a ngoáº¡i tham chiáº¿u Ä‘áº¿n cá»™t `id` trong báº£ng `thong_tin_chi_tiet`.
  * **`ThongTinChiTiet`** lÃ  **bÃªn Ä‘áº£o ngÆ°á»£c (inverse side)**. Annotation **`@OneToOne(mappedBy = "thongTinChiTiet")`** chá»‰ ra ráº±ng má»‘i quan há»‡ nÃ y Ä‘Æ°á»£c quáº£n lÃ½ bá»Ÿi trÆ°á»ng `thongTinChiTiet` trong lá»›p `Nguoi`. BÃªn Ä‘áº£o ngÆ°á»£c khÃ´ng chá»©a khÃ³a ngoáº¡i trong báº£ng CSDL tÆ°Æ¡ng á»©ng cá»§a nÃ³.
  * **`cascade = CascadeType.ALL`** trÃªn bÃªn sá»Ÿ há»¯u (`Nguoi`) nghÄ©a lÃ  báº¥t ká»³ thao tÃ¡c nÃ o (persist, merge, remove, refresh, detach) Ä‘Æ°á»£c thá»±c hiá»‡n trÃªn má»™t thá»±c thá»ƒ `Nguoi` cÅ©ng sáº½ tá»± Ä‘á»™ng Ä‘Æ°á»£c thá»±c hiá»‡n trÃªn thá»±c thá»ƒ `ThongTinChiTiet` liÃªn quan. ÄÃ¢y lÃ  má»™t cÃ¡ch quáº£n lÃ½ vÃ²ng Ä‘á»i cá»§a cÃ¡c thá»±c thá»ƒ liÃªn quan.
  * Khi lÆ°u má»™t Ä‘á»‘i tÆ°á»£ng `Nguoi` má»›i cÃ¹ng vá»›i `ThongTinChiTiet` liÃªn quan, JPA sáº½ tá»± Ä‘á»™ng insert cáº£ hai vÃ  thiáº¿t láº­p khÃ³a ngoáº¡i.

-----

## 2\. Má»‘i Quan Há»‡ One-to-Many / Many-to-One (Má»™t-Ä‘á»‘i-Nhiá»u / Nhiá»u-Ä‘á»‘i-Má»™t)

ÄÃ¢y lÃ  má»‘i quan há»‡ phá»• biáº¿n nháº¥t. Má»™t thá»±c thá»ƒ A cÃ³ thá»ƒ liÃªn káº¿t vá»›i **nhiá»u** thá»±c thá»ƒ B, nhÆ°ng má»—i thá»±c thá»ƒ B chá»‰ liÃªn káº¿t vá»›i **duy nháº¥t má»™t** thá»±c thá»ƒ A. VÃ­ dá»¥: má»™t tÃ¡c giáº£ viáº¿t nhiá»u sÃ¡ch, nhÆ°ng má»—i cuá»‘n sÃ¡ch chá»‰ cÃ³ má»™t tÃ¡c giáº£ chÃ­nh; má»™t danh má»¥c chá»©a nhiá»u sáº£n pháº©m, nhÆ°ng má»—i sáº£n pháº©m chá»‰ thuá»™c má»™t danh má»¥c.

Trong CSDL, má»‘i quan há»‡ nÃ y thÆ°á»ng Ä‘Æ°á»£c biá»ƒu diá»…n báº±ng cÃ¡ch Ä‘áº·t khÃ³a ngoáº¡i trong báº£ng **â€œmanyâ€ (bÃªn â€œnhiá»uâ€)** tham chiáº¿u Ä‘áº¿n khÃ³a chÃ­nh cá»§a báº£ng **â€œoneâ€ (bÃªn â€œmá»™tâ€)**. VÃ­ dá»¥, báº£ng `Books` cÃ³ cá»™t `author_id` tham chiáº¿u báº£ng `Authors`.

Trong JPA, chÃºng ta sá»­ dá»¥ng **`@OneToMany`** trÃªn bÃªn â€œmá»™tâ€ vÃ  **`@ManyToOne`** trÃªn bÃªn â€œnhiá»uâ€. Theo quy Æ°á»›c vÃ  thá»±c táº¿, bÃªn â€œnhiá»uâ€ (sá»Ÿ há»¯u khÃ³a ngoáº¡i trong CSDL) thÆ°á»ng lÃ  **bÃªn sá»Ÿ há»¯u (owning side)** trong JPA. VÃ¬ váº­y, `@ManyToOne` thÆ°á»ng lÃ  bÃªn sá»Ÿ há»¯u.

### VÃ­ Dá»¥: TÃ¡c Giáº£ vÃ  SÃ¡ch

ChÃºng ta cÃ³ hai thá»±c thá»ƒ: `TacGia` (Author) vÃ  `Sach` (Book). Má»™t tÃ¡c giáº£ cÃ³ thá»ƒ viáº¿t nhiá»u sÃ¡ch.

```java
@Entity
public class TacGia {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    private String tenTacGia;

    // Inverse side: One-to-Many relationship. Mapped by the 'tacGia' field in the Sach entity.
    @OneToMany(mappedBy = "tacGia", cascade = CascadeType.ALL, orphanRemoval = true)
    private List<Sach> danhSachSach;

    // Constructor to initialize the list
    public TacGia() {
        this.danhSachSach = new ArrayList<>();
    }

    // Helper method to add a book and maintain bidirectional link
    public void addSach(Sach sach) {
        danhSachSach.add(sach);
        sach.setTacGia(this); // Set the owning side
    }

    // Helper method to remove a book
    public void removeSach(Sach sach) {
        danhSachSach.remove(sach);
        sach.setTacGia(null); // Break the link
    }

    // Getters and Setters...
}

@Entity
public class Sach {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    private String tieuDe;

    // Owning side: Many-to-One relationship. Sach holds the foreign key to TacGia.
    @ManyToOne(fetch = FetchType.LAZY) // Lazy loading is often better for performance
    @JoinColumn(name = "tac_gia_id") // Specifies the FK column in the 'sach' table
    private TacGia tacGia;

    // Getters and Setters...
}
```

**Trong vÃ­ dá»¥ nÃ y:**

  * **`Sach`** lÃ  **bÃªn sá»Ÿ há»¯u (owning side)** vá»›i `@ManyToOne`. Annotation **`@JoinColumn(name = "tac_gia_id")`** chá»‰ ra ráº±ng báº£ng `sach` cÃ³ cá»™t `tac_gia_id` lÃ  khÃ³a ngoáº¡i tham chiáº¿u Ä‘áº¿n báº£ng `tac_gia`. ÄÃ¢y lÃ  nÆ¡i JPA sáº½ quáº£n lÃ½ viá»‡c thiáº¿t láº­p vÃ  cáº­p nháº­t khÃ³a ngoáº¡i.
  * **`TacGia`** lÃ  **bÃªn Ä‘áº£o ngÆ°á»£c (inverse side)** vá»›i `@OneToMany`. **`mappedBy = "tacGia"`** chá»‰ ra ráº±ng má»‘i quan há»‡ nÃ y Ä‘Æ°á»£c quáº£n lÃ½ bá»Ÿi trÆ°á»ng `tacGia` trong lá»›p `Sach`.
  * ChÃºng ta thÆ°á»ng sá»­ dá»¥ng cÃ¡c Collection nhÆ° `List` hoáº·c `Set` Ä‘á»ƒ biá»ƒu diá»…n bÃªn â€œnhiá»uâ€ (`danhSachSach` trong `TacGia`).
  * **`fetch = FetchType.LAZY`** trÃªn `@ManyToOne` (vÃ  thÆ°á»ng lÃ  default cho `@OneToMany`) lÃ  má»™t tá»‘i Æ°u hiá»‡u suáº¥t. NÃ³ chá»‰ táº£i dá»¯ liá»‡u cá»§a `TacGia` khi báº¡n truy cáº­p trÆ°á»ng `tacGia` cá»§a má»™t Ä‘á»‘i tÆ°á»£ng `Sach`, thay vÃ¬ táº£i ngay láº­p tá»©c khi load Ä‘á»‘i tÆ°á»£ng `Sach` (`EAGER`).
  * **`cascade = CascadeType.ALL`** vÃ  **`orphanRemoval = true`** trÃªn `@OneToMany` giÃºp quáº£n lÃ½ danh sÃ¡ch sÃ¡ch cá»§a tÃ¡c giáº£. `orphanRemoval = true` Ä‘áº·c biá»‡t há»¯u Ã­ch: náº¿u má»™t cuá»‘n sÃ¡ch bá»‹ xÃ³a khá»i danh sÃ¡ch `danhSachSach` cá»§a má»™t tÃ¡c giáº£ vÃ  cuá»‘n sÃ¡ch Ä‘Ã³ khÃ´ng cÃ²n Ä‘Æ°á»£c liÃªn káº¿t vá»›i tÃ¡c giáº£ nÃ o khÃ¡c, JPA sáº½ tá»± Ä‘á»™ng xÃ³a cuá»‘n sÃ¡ch Ä‘Ã³ khá»i CSDL.
  * CÃ¡c phÆ°Æ¡ng thá»©c helper **`addSach`** vÃ  **`removeSach`** trong `TacGia` lÃ  cÃ¡ch tá»‘t Ä‘á»ƒ Ä‘áº£m báº£o tÃ­nh nháº¥t quÃ¡n cá»§a má»‘i quan há»‡ hai chiá»u (**bidirectional relationship**) báº±ng cÃ¡ch thiáº¿t láº­p liÃªn káº¿t á»Ÿ cáº£ hai phÃ­a.

-----

## 3\. Má»‘i Quan Há»‡ Many-to-Many (Nhiá»u-Ä‘á»‘i-Nhiá»u)

Má»‘i quan há»‡ **Many-to-Many** xáº£y ra khi má»™t thá»±c thá»ƒ A cÃ³ thá»ƒ liÃªn káº¿t vá»›i **nhiá»u** thá»±c thá»ƒ B, vÃ  má»™t thá»±c thá»ƒ B cÅ©ng cÃ³ thá»ƒ liÃªn káº¿t vá»›i **nhiá»u** thá»±c thá»ƒ A. VÃ­ dá»¥: má»™t sinh viÃªn cÃ³ thá»ƒ Ä‘Äƒng kÃ½ nhiá»u khÃ³a há»c, vÃ  má»™t khÃ³a há»c cÃ³ thá»ƒ cÃ³ nhiá»u sinh viÃªn Ä‘Äƒng kÃ½; má»™t sáº£n pháº©m cÃ³ thá»ƒ cÃ³ nhiá»u tháº» (tags), vÃ  má»™t tháº» cÃ³ thá»ƒ Ä‘Æ°á»£c Ã¡p dá»¥ng cho nhiá»u sáº£n pháº©m.

Trong CSDL, má»‘i quan há»‡ Many-to-Many khÃ´ng thá»ƒ biá»ƒu diá»…n trá»±c tiáº¿p báº±ng má»™t khÃ³a ngoáº¡i Ä‘Æ¡n láº». NÃ³ yÃªu cáº§u má»™t **báº£ng trung gian (linking table, join table)** chá»©a hai khÃ³a ngoáº¡i, má»—i khÃ³a ngoáº¡i tham chiáº¿u Ä‘áº¿n khÃ³a chÃ­nh cá»§a má»™t trong hai báº£ng gá»‘c.

Trong JPA, chÃºng ta sá»­ dá»¥ng **`@ManyToMany`** trÃªn cáº£ hai thá»±c thá»ƒ. Má»™t trong hai bÃªn sáº½ Ä‘á»‹nh nghÄ©a báº£ng trung gian báº±ng **`@JoinTable`**.

### VÃ­ Dá»¥: Sinh ViÃªn vÃ  KhÃ³a Há»c

ChÃºng ta cÃ³ hai thá»±c thá»ƒ: `SinhVien` (Student) vÃ  `KhoaHoc` (Course). Má»™t sinh viÃªn cÃ³ thá»ƒ há»c nhiá»u khÃ³a há»c, vÃ  má»™t khÃ³a há»c cÃ³ nhiá»u sinh viÃªn.

```java
@Entity
public class SinhVien {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    private String tenSinhVien;

    // Owning side: Defines the join table
    @ManyToMany(cascade = { CascadeType.PERSIST, CascadeType.MERGE }) // Configure cascade types carefully
    @JoinTable(
        name = "sinh_vien_khoa_hoc", // Name of the linking table
        joinColumns = @JoinColumn(name = "sinh_vien_id"), // FK column in linking table referencing SinhVien
        inverseJoinColumns = @JoinColumn(name = "khoa_hoc_id") // FK column in linking table referencing KhoaHoc
    )
    private Set<KhoaHoc> danhSachKhoaHoc = new HashSet<>();

    // Helper methods to add/remove courses
    public void addKhoaHoc(KhoaHoc khoaHoc) {
        this.danhSachKhoaHoc.add(khoaHoc);
        khoaHoc.getDanhSachSinhVien().add(this); // Maintain bidirectional link
    }

    public void removeKhoaHoc(KhoaHoc khoaHoc) {
        this.danhSachKhoaHoc.remove(khoaHoc);
        khoaHoc.getDanhSachSinhVien().remove(this); // Maintain bidirectional link
    }

    // Getters and Setters...
}

@Entity
public class KhoaHoc {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    private String tenKhoaHoc;

    // Inverse side: Mapped by the field in the owning side
    @ManyToMany(mappedBy = "danhSachKhoaHoc")
    private Set<SinhVien> danhSachSinhVien = new HashSet<>();

     // Helper methods to add/remove students (often mirror those in the owning side)
    public void addSinhVien(SinhVien sinhVien) {
        this.danhSachSinhVien.add(sinhVien);
        sinhVien.getDanhSachKhoaHoc().add(this); // Maintain bidirectional link
    }

    public void removeSinhVien(SinhVien sinhVien) {
        this.danhSachSinhVien.remove(sinhVien);
        sinhVien.getDanhSachKhoaHoc().remove(this); // Maintain bidirectional link
    }


    // Getters and Setters...
}
```

**Trong vÃ­ dá»¥ nÃ y:**

  * ChÃºng ta sá»­ dá»¥ng **`Set`** cho cÃ¡c collection á»Ÿ cáº£ hai phÃ­a Ä‘á»ƒ trÃ¡nh cÃ¡c báº£n ghi trÃ¹ng láº·p trong báº£ng trung gian.
  * **`SinhVien`** Ä‘Æ°á»£c chá»n lÃ m **bÃªn sá»Ÿ há»¯u (owning side)**. NÃ³ Ä‘á»‹nh nghÄ©a báº£ng trung gian `sinh_vien_khoa_hoc` báº±ng **`@JoinTable`**.
      * `name = "sinh_vien_khoa_hoc"`: TÃªn cá»§a báº£ng trung gian.
      * `joinColumns = @JoinColumn(name = "sinh_vien_id")`: Cá»™t khÃ³a ngoáº¡i trong báº£ng trung gian tham chiáº¿u Ä‘áº¿n `SinhVien`.
      * `inverseJoinColumns = @JoinColumn(name = "khoa_hoc_id")`: Cá»™t khÃ³a ngoáº¡i trong báº£ng trung gian tham chiáº¿u Ä‘áº¿n `KhoaHoc`.
  * **`KhoaHoc`** lÃ  **bÃªn Ä‘áº£o ngÆ°á»£c (inverse side)**. **`mappedBy = "danhSachKhoaHoc"`** chá»‰ ra ráº±ng má»‘i quan há»‡ Ä‘Æ°á»£c quáº£n lÃ½ bá»Ÿi trÆ°á»ng `danhSachKhoaHoc` trong lá»›p `SinhVien`.
  * **`cascade`** trÃªn má»‘i quan há»‡ `@ManyToMany` cáº§n Ä‘Æ°á»£c cÃ¢n nháº¯c ká»¹ lÆ°á»¡ng. `PERSIST` vÃ  `MERGE` lÃ  phá»• biáº¿n Ä‘á»ƒ lÆ°u/cáº­p nháº­t cÃ¡c thá»±c thá»ƒ liÃªn quan, nhÆ°ng `REMOVE` thÆ°á»ng khÃ´ng mong muá»‘n (vÃ­ dá»¥: xÃ³a má»™t `SinhVien` khÃ´ng nÃªn xÃ³a táº¥t cáº£ `KhoaHoc` mÃ  há» Ä‘Ã£ Ä‘Äƒng kÃ½).

**LÆ°u Ã½ quan trá»ng:** Khi má»‘i quan há»‡ Many-to-Many cáº§n chá»©a thÃªm dá»¯ liá»‡u (vÃ­ dá»¥: ngÃ y Ä‘Äƒng kÃ½ khÃ³a há»c, Ä‘iá»ƒm sá»‘ cá»§a sinh viÃªn trong khÃ³a há»c Ä‘Ã³), mÃ´ hÃ¬nh báº£ng trung gian Ä‘Æ¡n thuáº§n sáº½ khÃ´ng Ä‘á»§. Trong trÆ°á»ng há»£p nÃ y, cÃ¡ch tá»‘t hÆ¡n lÃ  táº¡o má»™t thá»±c thá»ƒ riÃªng cho báº£ng trung gian (vÃ­ dá»¥: **`Enrollment`**) vÃ  mÃ´ hÃ¬nh hÃ³a má»‘i quan há»‡ Many-to-Many thÃ nh hai má»‘i quan há»‡ One-to-Many: `SinhVien` One-to-Many `Enrollment` vÃ  `KhoaHoc` One-to-Many `Enrollment`. ÄÃ¢y lÃ  má»™t ká»¹ thuáº­t ráº¥t phá»• biáº¿n vÃ  linh hoáº¡t.

-----

## 4\. CÃ¡c KhÃ­a Cáº¡nh Cáº§n CÃ¢n Nháº¯c

Khi lÃ m viá»‡c vá»›i cÃ¡c má»‘i quan há»‡ trong JPA, cÃ³ vÃ i Ä‘iá»u quan trá»ng cáº§n lÆ°u Ã½:

### Owning Side vÃ  Inverse Side

Hiá»ƒu rÃµ bÃªn nÃ o lÃ  **bÃªn sá»Ÿ há»¯u** lÃ  ráº¥t quan trá»ng. BÃªn sá»Ÿ há»¯u lÃ  bÃªn quáº£n lÃ½ (thÃªm/xÃ³a/cáº­p nháº­t) khÃ³a ngoáº¡i trong CSDL. Trong má»‘i quan há»‡ hai chiá»u, chá»‰ thao tÃ¡c trÃªn bÃªn sá»Ÿ há»¯u má»›i thá»±c sá»± áº£nh hÆ°á»Ÿng Ä‘áº¿n dá»¯ liá»‡u trong CSDL. BÃªn Ä‘áº£o ngÆ°á»£c chá»‰ lÃ  má»™t cÃ¡ch thuáº­n tiá»‡n Ä‘á»ƒ Ä‘iá»u hÆ°á»›ng qua má»‘i quan há»‡ tá»« phÃ­a kia.

  * **`mappedBy`**: Thuá»™c tÃ­nh nÃ y chá»‰ Ä‘Æ°á»£c sá»­ dá»¥ng trÃªn **bÃªn Ä‘áº£o ngÆ°á»£c** cá»§a má»‘i quan há»‡ hai chiá»u. NÃ³ trá» Ä‘áº¿n tÃªn trÆ°á»ng á»Ÿ bÃªn sá»Ÿ há»¯u Ä‘á»‹nh nghÄ©a cÃ¹ng má»™t má»‘i quan há»‡.

### `@JoinColumn` vÃ  `@JoinTable`

  * **`@JoinColumn`**: ÄÆ°á»£c sá»­ dá»¥ng trÃªn **bÃªn sá»Ÿ há»¯u** cá»§a má»‘i quan há»‡ **One-to-One** vÃ  **Many-to-One** Ä‘á»ƒ chá»‰ Ä‘á»‹nh tÃªn cá»™t khÃ³a ngoáº¡i trong báº£ng cá»§a bÃªn sá»Ÿ há»¯u.
  * **`@JoinTable`**: ÄÆ°á»£c sá»­ dá»¥ng trÃªn **bÃªn sá»Ÿ há»¯u** cá»§a má»‘i quan há»‡ **Many-to-Many** Ä‘á»ƒ Ä‘á»‹nh nghÄ©a báº£ng trung gian vÃ  cÃ¡c cá»™t khÃ³a ngoáº¡i cá»§a nÃ³.

### Fetch Types (`FetchType.LAZY` vs `FetchType.EAGER`)

  * **`EAGER`** (máº·c Ä‘á»‹nh cho `@OneToOne`, `@ManyToOne`): Táº£i dá»¯ liá»‡u cá»§a cÃ¡c thá»±c thá»ƒ liÃªn quan **ngay láº­p tá»©c** khi thá»±c thá»ƒ chÃ­nh Ä‘Æ°á»£c táº£i. CÃ³ thá»ƒ gÃ¢y lÃ£ng phÃ­ tÃ i nguyÃªn náº¿u báº¡n khÃ´ng luÃ´n cáº§n dá»¯ liá»‡u liÃªn quan.
  * **`LAZY`** (máº·c Ä‘á»‹nh cho `@OneToMany`, `@ManyToMany`): Chá»‰ táº£i dá»¯ liá»‡u cá»§a cÃ¡c thá»±c thá»ƒ liÃªn quan **khi báº¡n truy cáº­p** trÆ°á»ng tÆ°Æ¡ng á»©ng láº§n Ä‘áº§u tiÃªn. GiÃºp tá»‘i Æ°u hiá»‡u suáº¥t báº±ng cÃ¡ch chá»‰ táº£i nhá»¯ng gÃ¬ cáº§n thiáº¿t, nhÆ°ng cÃ³ thá»ƒ dáº«n Ä‘áº¿n váº¥n Ä‘á» **N+1 Select** náº¿u khÃ´ng Ä‘Æ°á»£c quáº£n lÃ½ Ä‘Ãºng cÃ¡ch (vÃ­ dá»¥: láº·p qua má»™t danh sÃ¡ch vÃ  truy cáº­p má»‘i quan há»‡ lazy cho tá»«ng má»¥c trong vÃ²ng láº·p).

NÃªn Æ°u tiÃªn sá»­ dá»¥ng **`LAZY`** vÃ  sá»­ dá»¥ng cÃ¡c ká»¹ thuáº­t nhÆ° **fetch joins** trong JPQL/HQL hoáº·c cÃ¡c tÃ­nh nÄƒng cá»§a Spring Data JPA Ä‘á»ƒ táº£i trÆ°á»›c dá»¯ liá»‡u EAGERLY khi cáº§n thiáº¿t cho cÃ¡c trÆ°á»ng há»£p sá»­ dá»¥ng cá»¥ thá»ƒ.

### Cascade Types (`CascadeType`)

  * **`PERSIST`**: Thao tÃ¡c persist (lÆ°u) thá»±c thá»ƒ chÃ­nh sáº½ cascade Ä‘áº¿n thá»±c thá»ƒ liÃªn quan.
  * **`MERGE`**: Thao tÃ¡c merge (cáº­p nháº­t) thá»±c thá»ƒ chÃ­nh sáº½ cascade Ä‘áº¿n thá»±c thá»ƒ liÃªn quan.
  * **`REMOVE`**: Thao tÃ¡c remove (xÃ³a) thá»±c thá»ƒ chÃ­nh sáº½ cascade Ä‘áº¿n thá»±c thá»ƒ liÃªn quan. Cáº§n ráº¥t cáº©n tháº­n vá»›i cÃ¡i nÃ y, Ä‘áº·c biá»‡t trong má»‘i quan há»‡ Many-to-Many.
  * **`ALL`**: Cascade táº¥t cáº£ cÃ¡c thao tÃ¡c (PERSIST, MERGE, REMOVE, REFRESH, DETACH).
  * **`orphanRemoval = true`** (chá»‰ trÃªn `@OneToMany`, `@OneToOne`): Náº¿u má»™t thá»±c thá»ƒ con bá»‹ gá»¡ bá» khá»i collection cá»§a thá»±c thá»ƒ cha, nÃ³ sáº½ bá»‹ xÃ³a khá»i CSDL.

Viá»‡c cáº¥u hÃ¬nh cascade Ä‘Ãºng cÃ¡ch giÃºp quáº£n lÃ½ vÃ²ng Ä‘á»i cá»§a cÃ¡c thá»±c thá»ƒ liÃªn quan má»™t cÃ¡ch tá»± Ä‘á»™ng, nhÆ°ng cáº¥u hÃ¬nh sai cÃ³ thá»ƒ dáº«n Ä‘áº¿n máº¥t dá»¯ liá»‡u khÃ´ng mong muá»‘n.

### Bidirectional vs Unidirectional

  * **Unidirectional**: Má»‘i quan há»‡ chá»‰ Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a á»Ÿ má»™t phÃ­a (chá»‰ cÃ³ liÃªn káº¿t tá»« A sang B, khÃ´ng cÃ³ tá»« B vá» A). ÄÆ¡n giáº£n hÆ¡n Ä‘á»ƒ code, nhÆ°ng báº¡n khÃ´ng thá»ƒ Ä‘iá»u hÆ°á»›ng ngÆ°á»£c láº¡i tá»« B vá» A thÃ´ng qua má»‘i quan há»‡ JPA.
  * **Bidirectional**: Má»‘i quan há»‡ Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a á»Ÿ cáº£ hai phÃ­a (cÃ³ liÃªn káº¿t tá»« A sang B vÃ  tá»« B vá» A). Cho phÃ©p Ä‘iá»u hÆ°á»›ng linh hoáº¡t hÆ¡n, nhÆ°ng Ä‘Ã²i há»i code phá»©c táº¡p hÆ¡n má»™t chÃºt Ä‘á»ƒ quáº£n lÃ½ tÃ­nh nháº¥t quÃ¡n á»Ÿ cáº£ hai phÃ­a (nhÆ° cÃ¡c helper methods `addSach`/`removeSach` Ä‘Ã£ tháº¥y).

Chá»n loáº¡i nÃ o phá»¥ thuá»™c vÃ o yÃªu cáº§u cá»§a á»©ng dá»¥ng.

-----

## 5\. TÃ³m Táº¯t CÃ¡c Loáº¡i Má»‘i Quan Há»‡

Äá»ƒ dá»… hÃ¬nh dung, Ä‘Ã¢y lÃ  báº£ng tÃ³m táº¯t cÃ¡c Ä‘iá»ƒm chÃ­nh cá»§a ba loáº¡i má»‘i quan há»‡:

| Má»‘i Quan Há»‡ | Annotation (BÃªn Sá»Ÿ há»¯u) | Annotation (BÃªn Äáº£o ngÆ°á»£c, náº¿u hai chiá»u) | Cáº¥u TrÃºc Báº£ng CSDL | Vai TrÃ² KhÃ³a Ngoáº¡i/Báº£ng Trung Gian | VÃ­ Dá»¥ Phá»• Biáº¿n |
| :--- | :--- | :--- | :--- | :--- | :--- |
| **One-to-One (1:1)** | `@OneToOne` (vá»›i `@JoinColumn`) | `@OneToOne` (vá»›i `mappedBy`) | Má»™t FK trong báº£ng cá»§a bÃªn sá»Ÿ há»¯u trá» Ä‘áº¿n PK cá»§a bÃªn kia. | BÃªn sá»Ÿ há»¯u chá»©a FK. | NgÆ°á»i \<-\> ThÃ´ng tin chi tiáº¿t cÃ¡ nhÃ¢n |
| **One-to-Many (1:N) / Many-to-One (N:1)** | `@ManyToOne` (vá»›i `@JoinColumn`) | `@OneToMany` (vá»›i `mappedBy`) | Má»™t FK trong báº£ng â€œnhiá»uâ€ (Many side) trá» Ä‘áº¿n PK cá»§a báº£ng â€œmá»™tâ€ (One side). | BÃªn â€œnhiá»uâ€ (`@ManyToOne`) chá»©a FK. | TÃ¡c giáº£ \<-\> SÃ¡ch, Danh má»¥c \<-\> Sáº£n pháº©m |
| **Many-to-Many (N:M)** | `@ManyToMany` (vá»›i `@JoinTable`) | `@ManyToMany` (vá»›i `mappedBy`) | Má»™t báº£ng trung gian chá»©a hai FK, má»—i FK trá» Ä‘áº¿n PK cá»§a má»™t trong hai báº£ng gá»‘c. | BÃªn sá»Ÿ há»¯u Ä‘á»‹nh nghÄ©a báº£ng trung gian. | Sinh viÃªn \<-\> KhÃ³a há»c, Sáº£n pháº©m \<-\> Tháº» (Tag) |

# Derived query methods (truy váº¥n theo tÃªn hÃ m)
Tuyá»‡t vá»i\! ÄÃ¢y lÃ  toÃ n bá»™ ná»™i dung hÆ°á»›ng dáº«n cá»§a báº¡n vá» Derived Query Methods trong Spring Data JPA Ä‘Ã£ Ä‘Æ°á»£c chuyá»ƒn sang Ä‘á»‹nh dáº¡ng Markdown rÃµ rÃ ng vÃ  cÃ³ cáº¥u trÃºc.

# Derived Query Methods trong Spring Data JPA Repositories

## 1\. Giá»›i Thiá»‡u

Äá»‘i vá»›i cÃ¡c truy váº¥n Ä‘Æ¡n giáº£n, tháº­t dá»… dÃ ng Ä‘á»ƒ tÃ¬m ra truy váº¥n chá»‰ báº±ng cÃ¡ch nhÃ¬n vÃ o tÃªn cÃ¡c phÆ°Æ¡ng thá»©c tÆ°Æ¡ng á»©ng trong cÃ¡c Ä‘oáº¡n mÃ£.

Váº­y khi chÃºng ta muá»‘n tá»± custom hay lÃ  lá»±a chá»n cÃ¡c cÃ¢u truy váº¥n theo cÃ¡c phÆ°Æ¡ng thá»©c mÃ  báº£n thÃ¢n chÃºng ta tá»± Ä‘áº·t ra theo bÃ i toÃ¡n cá»§a mÃ¬nh thÃ¬ pháº£i lÃ m nhÆ° tháº¿ nÃ o?

Trong hÆ°á»›ng dáº«n nÃ y, chÃºng ta sáº½ cÃ¹ng khÃ¡m phÃ¡ cÃ¡ch Spring Data JPA táº­n dá»¥ng Ã½ tÆ°á»Ÿng nÃ y dÆ°á»›i dáº¡ng má»™t **quy Æ°á»›c Ä‘áº·t tÃªn phÆ°Æ¡ng thá»©c** Ä‘á»ƒ tá»± Ä‘á»™ng táº¡o truy váº¥n.

## 2\. Cáº¥u trÃºc cá»§a phÆ°Æ¡ng thá»©c truy váº¥n cÃ³ nguá»“n gá»‘c trong Spring

TÃªn phÆ°Æ¡ng thá»©c xuáº¥t phÃ¡t tá»« 2 pháº§n chÃ­nh Ä‘Æ°á»£c phÃ¢n tÃ¡ch báº±ng tá»« khÃ³a **`By`** Ä‘áº§u tiÃªn:

```java
List<User> findByName(String name)
```

1.  **Pháº§n Ä‘áº§u tiÃªn (NgÆ°á»i giá»›i thiá»‡u):** Cháº³ng háº¡n nhÆ° `find`.
      * Spring Data JPA há»— trá»£: **`find`**, **`read`**, **`query`**, **`count`** vÃ  **`get`**. (VÃ­ dá»¥: `queryByName` sáº½ hoáº¡t Ä‘á»™ng tÆ°Æ¡ng tá»± `findByName`).
      * ChÃºng ta cÅ©ng cÃ³ thá»ƒ sá»­ dá»¥ng **`Distinct`**, **`First`** hoáº·c **`Top`** cÃ¹ng Ä‘á»ƒ loáº¡i bá» cÃ¡c báº£n sao hoáº·c giá»›i háº¡n táº­p há»£p káº¿t quáº£ cá»§a chÃºng tÃ´i:
        ```java
        List<User> findTop3ByAge()
        ```
2.  **Pháº§n cÃ²n láº¡i (TiÃªu chÃ­):** Cháº³ng háº¡n nhÆ° `ByName`, lÃ  tiÃªu chÃ­ Ä‘iá»u kiá»‡n.
      * Pháº§n tiÃªu chÃ­ chá»©a cÃ¡c biá»ƒu thá»©c Ä‘iá»u kiá»‡n cá»¥ thá»ƒ cá»§a thá»±c thá»ƒ cá»§a truy váº¥n. ChÃºng ta sá»­ dá»¥ng cÃ¡c tá»« khÃ³a Ä‘iá»u kiá»‡n cÃ¹ng vá»›i tÃªn thuá»™c tÃ­nh cá»§a thá»±c thá»ƒ.
      * ChÃºng ta cÃ³ thá»ƒ ná»‘i cÃ¡c biá»ƒu thá»©c vá»›i **`And`** vÃ  **`Or`**.

## 3\. á»¨ng dá»¥ng máº«u

Äáº§u tiÃªn, chÃºng ta xÃ¡c Ä‘á»‹nh má»™t lá»›p thá»±c thá»ƒ:

```java
@Table(name = "users")
@Entity
class User {
    @Id
    @GeneratedValue
    private Integer id;
    
    private String name;
    private Integer age;
    private ZonedDateTime birthDate;
    private Boolean active;

    // standard getters and setters
}
```

HÃ£y cÃ¹ng xÃ¡c Ä‘á»‹nh má»™t kho lÆ°u trá»¯ (Repository). NÃ³ sáº½ má»Ÿ rá»™ng `JpaRepository`:

```java
interface UserRepository extends JpaRepository<User, Integer> {}
```

ÄÃ¢y lÃ  nÆ¡i chÃºng tÃ´i sáº½ Ä‘áº·t táº¥t cáº£ cÃ¡c phÆ°Æ¡ng thá»©c truy váº¥n báº¯t nguá»“n cá»§a chÃºng tÃ´i.

-----

## 4\. Tá»« khoÃ¡ Äiá»u kiá»‡n BÃ¬nh Ä‘áº³ng (= / IS)

BÃ¬nh Ä‘áº³ng chÃ­nh xÃ¡c lÃ  má»™t trong nhá»¯ng Ä‘iá»u kiá»‡n Ä‘Æ°á»£c sá»­ dá»¥ng nhiá»u nháº¥t. ChÃºng tÃ´i cÃ³ má»™t sá»‘ tÃ¹y chá»n Ä‘á»ƒ thá»ƒ hiá»‡n cÃ¡c toÃ¡n tá»­ `=` hoáº·c `IS` trong truy váº¥n.

| CÃº phÃ¡p TÃªn phÆ°Æ¡ng thá»©c | VÃ­ dá»¥ (Java) | MÃ´ táº£ |
| :--- | :--- | :--- |
| **TÃªn thuá»™c tÃ­nh (Ngáº§m Ä‘á»‹nh)** | `List<User> findByName(String name);` | Äiá»u kiá»‡n Ä‘á»‘i sÃ¡nh chÃ­nh xÃ¡c (`=`). |
| **`Is` / `Equals`** | `List<User> findByNameIs(String name);` | TÄƒng kháº£ nÄƒng Ä‘á»c. |
| | `List<User> findByNameEquals(String name);` | TÄƒng kháº£ nÄƒng Ä‘á»c. |
| **`IsNot`** | `List<User> findByNameIsNot(String name);` | Thá»ƒ hiá»‡n sá»± báº¥t bÃ¬nh Ä‘áº³ng (`!=`). |
| **`IsNull` / `IsNotNull`** | `List<User> findByNameIsNull();` | Äiá»u kiá»‡n `IS NULL`. **KhÃ´ng** yÃªu cáº§u Ä‘á»‘i sá»‘ phÆ°Æ¡ng thá»©c. |
| | `List<User> findByNameIsNotNull();` | Äiá»u kiá»‡n `IS NOT NULL`. **KhÃ´ng** yÃªu cáº§u Ä‘á»‘i sá»‘ phÆ°Æ¡ng thá»©c. |
| **`True` / `False`** (Ãp dá»¥ng cho Boolean) | `List<User> findByActiveTrue();` | `WHERE active = TRUE`. **KhÃ´ng** yÃªu cáº§u Ä‘á»‘i sá»‘. |
| | `List<User> findByActiveFalse()` | `WHERE active = FALSE`. **KhÃ´ng** yÃªu cáº§u Ä‘á»‘i sá»‘. |

> **LÆ°u Ã½ vá» Null:** Spring Data JPA xá»­ lÃ½ cÃ¡c tham sá»‘ `null` theo máº·c Ä‘á»‹nh. Khi chÃºng ta chuyá»ƒn má»™t giÃ¡ trá»‹ `null` cho má»™t Ä‘iá»u kiá»‡n bÃ¬nh Ä‘áº³ng, Spring sáº½ diá»…n giáº£i truy váº¥n lÃ  **`IS NULL`** trong SQL Ä‘Æ°á»£c táº¡o.

-----

## 5\. Tá»« khÃ³a Ä‘iá»u kiá»‡n tÆ°Æ¡ng tá»± (LIKE)

Khi chÃºng tÃ´i cáº§n truy váº¥n káº¿t quáº£ vá»›i má»™t máº«u thuá»™c tÃ­nh (chuá»—i), chÃºng tÃ´i cÃ³ má»™t vÃ i tÃ¹y chá»n.

| CÃº phÃ¡p TÃªn phÆ°Æ¡ng thá»©c | VÃ­ dá»¥ (Java) | MÃ´ táº£ (TÆ°Æ¡ng Ä‘Æ°Æ¡ng SQL) |
| :--- | :--- | :--- |
| **`StartingWith`** | `List<User> findByNameStartingWith(String prefix);` | `WHERE name LIKE 'prefix%'` |
| **`EndingWith`** | `List<User> findByNameEndingWith(String suffix);` | `WHERE name LIKE '%suffix'` |
| **`Containing`** | `List<User> findByNameContaining(String infix);` | `WHERE name LIKE '%infix%'` |
| **`Like`** | `List<User> findByNameLike(String likePattern);` | `WHERE name LIKE likePattern` |

> **LÆ°u Ã½:**
>
> 1.  Vá»›i `StartingWith`, `EndingWith`, `Containing`, chÃºng ta **khÃ´ng cáº§n** thÃªm toÃ¡n tá»­ `%` vÃ o bÃªn trong Ä‘á»‘i sá»‘ khi cÃ¡c phÆ°Æ¡ng thá»©c nÃ y Ä‘Æ°á»£c gá»i.
> 2.  Vá»›i tá»« khÃ³a **`Like`**, chÃºng ta **pháº£i** truyá»n vÃ o máº«u `LIKE` cá»§a mÃ¬nh, vÃ­ dá»¥:
>     ```java
>     String likePattern = "a%b%c";
>     userRepository.findByNameLike(likePattern);
>     ```

-----

## 6\. Tá»« khÃ³a Ä‘iá»u kiá»‡n so sÃ¡nh

ChÃºng ta cÃ³ thá»ƒ sá»­ dá»¥ng cÃ¡c tá»« khÃ³a so sÃ¡nh cho cÃ¡c kiá»ƒu dá»¯ liá»‡u cÃ³ thá»ƒ so sÃ¡nh Ä‘Æ°á»£c (sá»‘, ngÃ y thÃ¡ng, v.v.).

| CÃº phÃ¡p TÃªn phÆ°Æ¡ng thá»©c | VÃ­ dá»¥ (Java) | MÃ´ táº£ (ToÃ¡n tá»­) |
| :--- | :--- | :--- |
| **`LessThan`** | `List<User> findByAgeLessThan(Integer age);` | `<` |
| **`LessThanEqual`** | `List<User> findByAgeLessThanEqual(Integer age);` | `<=` |
| **`GreaterThan`** | `List<User> findByAgeGreaterThan(Integer age);` | `>` |
| **`GreaterThanEqual`** | `List<User> findByAgeGreaterThanEqual(Integer age);` | `>=` |
| **`Between`** | `List<User> findByAgeBetween(Integer startAge, Integer endAge);` | `BETWEEN` (YÃªu cáº§u hai Ä‘á»‘i sá»‘) |
| **`In`** | `List<User> findByAgeIn(Collection<Integer> ages);` | `IN` (YÃªu cáº§u má»™t Collection) |
| **`Before`** (DÃ nh cho Date/Time) | `List<User> findByBirthDateBefore(ZonedDateTime birthDate);` | TrÆ°á»›c ngÃ y Ä‘Æ°á»£c chá»‰ Ä‘á»‹nh. |
| **`After`** (DÃ nh cho Date/Time) | `List<User> findByBirthDateAfter(ZonedDateTime birthDate);` | Sau ngÃ y Ä‘Æ°á»£c chá»‰ Ä‘á»‹nh. |

-----

## 7\. Biá»ƒu thá»©c nhiá»u Ä‘iá»u kiá»‡n

ChÃºng ta cÃ³ thá»ƒ káº¿t há»£p bao nhiÃªu biá»ƒu thá»©c náº¿u chÃºng ta cáº§n báº±ng cÃ¡ch sá»­ dá»¥ng cÃ¡c tá»« khÃ³a **`Or`** vÃ  **`And`**:

```java
// WHERE name = ?1 OR birthDate = ?2
List<User> findByNameOrBirthDate(String name, ZonedDateTime birthDate);

// WHERE name = ?1 OR (birthDate = ?2 AND active = ?3)
List<User> findByNameOrBirthDateAndActive(String name, ZonedDateTime birthDate, Boolean active);
```

> **LÆ°u Ã½ vá» Thá»© tá»± Æ¯u tiÃªn:** Thá»© tá»± Æ°u tiÃªn lÃ  **`AND`** sau Ä‘Ã³ lÃ  **`OR`**, giá»‘ng nhÆ° Java.

Máº·c dÃ¹ Spring Data JPA khÃ´ng Ã¡p Ä‘áº·t giá»›i háº¡n vá» sá»‘ lÆ°á»£ng biá»ƒu thá»©c, nhÆ°ng khÃ´ng nÃªn táº¡o ra cÃ¡c tÃªn phÆ°Æ¡ng thá»©c quÃ¡ dÃ i, khÃ³ Ä‘á»c vÃ  khÃ³ duy trÃ¬. Äá»‘i vá»›i cÃ¡c truy váº¥n phá»©c táº¡p, hÃ£y sá»­ dá»¥ng chÃº thÃ­ch **`@Query`**.

-----

## 8\. Sáº¯p xáº¿p káº¿t quáº£

ChÃºng ta cÃ³ thá»ƒ yÃªu cáº§u sáº¯p xáº¿p káº¿t quáº£ báº±ng cÃ¡ch thÃªm **`OrderBy`** vÃ o cuá»‘i tÃªn phÆ°Æ¡ng thá»©c.

```java
// Sáº¯p xáº¿p theo tÃªn. Thá»© tá»± tÄƒng dáº§n (ASC) lÃ  máº·c Ä‘á»‹nh.
List<User> findByNameOrderByName(String name);

// Chá»‰ Ä‘á»‹nh rÃµ rÃ ng sáº¯p xáº¿p tÄƒng dáº§n
List<User> findByNameOrderByNameAsc(String name);

// Chá»‰ Ä‘á»‹nh sáº¯p xáº¿p giáº£m dáº§n
List<User> findByNameOrderByNameDesc(String name);
```

-----

## 9\. `findOne` so vá»›i `findById` trong CrudRepository

NhÃ³m Spring Ä‘Ã£ thá»±c hiá»‡n má»™t sá»‘ thay Ä‘á»•i lá»›n trong `CrudRepository` vá»›i Spring Boot 2.x. Má»™t trong sá»‘ Ä‘Ã³ lÃ  Ä‘á»•i tÃªn `findOne` thÃ nh **`findById`**.

  * **TrÆ°á»›c Spring Boot 2.x (1.x):** ChÃºng ta sáº½ gá»i `findOne` khi muá»‘n truy xuáº¥t má»™t thá»±c thá»ƒ báº±ng khÃ³a chÃ­nh:
    ```java
    User user = userRepository.findOne(1);
    ```
  * **Ká»ƒ tá»« Spring Boot 2.x:** ChÃºng ta cÃ³ thá»ƒ lÃ m tÆ°Æ¡ng tá»± vá»›i `findById`:
    ```java
    User user = userRepository.findById(1);
    ```

> **LÆ°u Ã½:** PhÆ°Æ¡ng thá»©c **`findById()`** Ä‘Ã£ Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a trong **`CrudRepository`** (vÃ  cÃ¡c interface con nhÆ° `JpaRepository`). VÃ¬ váº­y, chÃºng ta khÃ´ng cáº§n pháº£i xÃ¡c Ä‘á»‹nh nÃ³ má»™t cÃ¡ch rÃµ rÃ ng trong cÃ¡c kho lÆ°u trá»¯ tÃ¹y chá»‰nh.
# JPQL vá»›i @Query
# Native query (SQL thuáº§n)
ÄÃ¢y lÃ  ná»™i dung hÆ°á»›ng dáº«n cá»§a báº¡n vá» **Native Queries** trong Spring Data JPA, Ä‘Ã£ Ä‘Æ°á»£c chuyá»ƒn sang Ä‘á»‹nh dáº¡ng Markdown rÃµ rÃ ng vÃ  cÃ³ cáº¥u trÃºc.

# Native Queries trong Spring Data JPA

## Äá»‹nh nghÄ©a Native Queries (Truy váº¥n thuáº§n)

**Native Queries** lÃ  cÃ¡c cÃ¢u lá»‡nh SQL thuáº§n (SQL-92 hoáº·c cÃº phÃ¡p SQL Ä‘áº·c trÆ°ng cho RDBMS) Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a vÃ  thá»±c thi trá»±c tiáº¿p qua JPA/Hibernate, nhÆ°ng Ä‘Æ°á»£c Ä‘Æ¡n giáº£n hÃ³a báº±ng Spring Data JPA.

Khi sá»­ dá»¥ng Spring Data JPA, Ä‘á»ƒ Ä‘á»‹nh nghÄ©a má»™t native query, chÃºng ta chÃº thÃ­ch repository method cá»§a mÃ¬nh báº±ng `@Query`, Ä‘áº·t thuá»™c tÃ­nh **`nativeQuery=true`** vÃ  cung cáº¥p má»™t cÃ¢u lá»‡nh SQL lÃ m giÃ¡ trá»‹.

```java
@Repository
public interface AuthorRepository extends CrudRepository<Author, Long>, PagingAndSortingRepository<Author, Long> {
 
    @Query(value="select * from author a where a.first_name= :firstName", nativeQuery=true)
    List<Author> getAuthorsByFirstName(String firstName);
   
}
```

Trong vÃ­ dá»¥ trÃªn, chÃºng ta cÃ³ thá»ƒ sá»­ dá»¥ng cÃ¡c tham sá»‘ (vÃ­ dá»¥: `:firstName`) giá»‘ng nhÆ° trong custom JPQL query.

**CÃ¡ch thá»±c thi:**

```java
List<Author> authors = authorRepository.getAuthorsByFirstName("Janssen");
```

Spring Data repository sáº½ thá»±c thi cÃ¢u lá»‡nh SQL Ä‘Æ°á»£c cung cáº¥p, truyá»n cÃ¡c giÃ¡ trá»‹ tham sá»‘ tÆ°Æ¡ng á»©ng, vÃ  khá»Ÿi táº¡o cÃ¡c thá»±c thá»ƒ (`Author`) tá»« káº¿t quáº£.

-----

## Viáº¿t hoáº¡t Ä‘á»™ng (Delete, Update) dÆ°á»›i dáº¡ng Native Queries

CÃ¡c hoáº¡t Ä‘á»™ng ghi (write operations) nhÆ° `DELETE` hoáº·c `UPDATE` cÅ©ng cÃ³ thá»ƒ Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a báº±ng native SQL. VÃ¬ cÃ¡c thao tÃ¡c nÃ y thay Ä‘á»•i dá»¯ liá»‡u, chÃºng cáº§n Ä‘Æ°á»£c Ä‘Ã¡nh dáº¥u báº±ng annotation **`@Modifying`** ngoÃ i `@Query` vÃ  `nativeQuery=true`.

```java
@Repository
public interface AuthorRepository extends CrudRepository<Author, Long>, PagingAndSortingRepository<Author, Long> {
 
    @Modifying
    @Query(value="delete from author a where a.last_name= :lastName", nativeQuery = true)
    void deleteAuthorByLastName(@Param("lastName") String lastName);
     
    @Modifying
    @Query(value="update author set last_name= :lastName where first_name = :firstName", nativeQuery=true)
    void updateAuthorByFirstName(String firstName, String lastName);
}
```

-----

## Háº¡n cháº¿ cá»§a Native Queries trong Spring Data JPA

Khi dÃ¹ng native queries, cÃ³ nhá»¯ng háº¡n cháº¿ sau:

1.  **TÃ­nh di Ä‘á»™ng (Portability):** Spring Data JPA vÃ  persistence provider **khÃ´ng tá»± Ä‘iá»u chá»‰nh** truy váº¥n theo ngÃ´n ngá»¯ SQL cá»§a má»™t cÆ¡ sá»Ÿ dá»¯ liá»‡u cá»¥ thá»ƒ. ChÃºng ta cáº§n Ä‘áº£m báº£o ráº±ng cÃº phÃ¡p SQL cung cáº¥p Ä‘Æ°á»£c há»— trá»£ bá»Ÿi táº¥t cáº£ RDBMS mÃ  á»©ng dá»¥ng há»— trá»£.
2.  **PhÃ¢n trang (Pagination):** PhÃ¢n trang káº¿t quáº£ truy váº¥n native yÃªu cáº§u thÃªm má»™t bÆ°á»›c.
3.  **Sáº¯p xáº¿p Ä‘á»™ng (Dynamic Sorting):** Spring Data JPA **khÃ´ng há»— trá»£** sáº¯p xáº¿p Ä‘á»™ng cho cÃ¡c cÃ¢u lá»‡nh native SQL.

### ThÃªm Count Query Ä‘á»ƒ PhÃ¢n trang

Khi sá»­ dá»¥ng `Pageable` vá»›i native query, chÃºng ta cáº§n cung cáº¥p cÃ¢u lá»‡nh **`count query`** Ä‘á»ƒ Spring Data JPA cÃ³ thá»ƒ tráº£ vá» tá»•ng sá»‘ báº£n ghi vÃ  tÃ­nh toÃ¡n tá»•ng sá»‘ trang.

ChÃºng ta lÃ m Ä‘iá»u Ä‘Ã³ báº±ng cÃ¡ch cung cáº¥p giÃ¡ trá»‹ cho thuá»™c tÃ­nh **`countQuery`** trong annotation `@Query`.

```java
@Repository
public interface AuthorRepository extends CrudRepository<Author, Long>, PagingAndSortingRepository<Author, Long> {
     
    @Query(value="select * from author a where a.last_name= ?1", 
            countQuery = "select count(id) from author a where a.last_name= ?1", 
            nativeQuery = true)
    Page<Author> getAuthorsByLastName(String lastname, Pageable page);
     
    // ...
}
```

**TrÆ°á»ng há»£p Named Native Query:**
Náº¿u sá»­ dá»¥ng `named native query`, chÃºng ta cáº§n bá»• sung thÃªm má»™t `named native query` ná»¯a Ä‘á»ƒ láº¥y tá»•ng sá»‘ báº£n ghi vÃ  thÃªm háº­u tá»‘ **`.count`** vÃ o tÃªn cá»§a nÃ³.

```java
@NamedNativeQuery(name = "Author.getAuthorsByLastName", 
                    query = "select * from author a where a.last_name= ?1", 
                    resultClass = Author.class)
@NamedNativeQuery(name = "Author.getAuthorsByLastName.count", 
                    query = "select count(id) from author a where a.last_name= ?1")
@Entity
public class Author { ... }
```

### KhÃ´ng cÃ³ Sáº¯p xáº¿p Äá»™ng

Ráº¥t tiáº¿c, Spring Data JPA **khÃ´ng há»— trá»£** thÃªm tham sá»‘ kiá»ƒu `Sort` Ä‘á»ƒ xÃ¡c Ä‘á»‹nh tiÃªu chÃ­ sáº¯p xáº¿p trong thá»i gian cháº¡y cho native query.

  * Äiá»u nÃ y lÃ  do nÃ³ yÃªu cáº§u Spring Data phÃ¢n tÃ­ch cÃ¢u lá»‡nh SQL thuáº§n vÃ  táº¡o má»‡nh Ä‘á» `ORDER BY` dÃ nh riÃªng cho cÆ¡ sá»Ÿ dá»¯ liá»‡u, má»™t hoáº¡t Ä‘á»™ng ráº¥t phá»©c táº¡p.
  * Náº¿u cáº§n sáº¯p xáº¿p, chÃºng ta **cáº§n bá»• sung má»‡nh Ä‘á» `ORDER BY`** vÃ o trá»±c tiáº¿p trong cÃ¢u lá»‡nh truy váº¥n. Äiá»u nÃ y lÃ m giáº£m tÃ­nh linh Ä‘á»™ng cá»§a truy váº¥n.
  * Äá»ƒ cÃ³ há»— trá»£ sáº¯p xáº¿p Ä‘á»™ng cho cÃ¡c truy váº¥n phá»©c táº¡p, cÃ¡ch tá»‘t hÆ¡n lÃ  sá»­ dá»¥ng **`Criteria API`** cá»§a JPA.

## Káº¿t luáº­n

**Native Queries** ráº¥t máº¡nh máº½ vÃ  linh hoáº¡t, cho phÃ©p chÃºng ta táº­n dá»¥ng táº¥t cáº£ cÃ¡c tÃ­nh nÄƒng Ä‘Æ°á»£c cÆ¡ sá»Ÿ dá»¯ liá»‡u há»— trá»£. Tuy nhiÃªn, chÃºng phá»©c táº¡p hÆ¡n `derived query` vÃ  cÃ³ nhá»¯ng háº¡n cháº¿ so vá»›i `custom JPQL query`:

  * Cáº§n bá»• sung thuá»™c tÃ­nh **`countQuery`** trong `@Query` Ä‘á»ƒ phÃ¢n trang.
  * **KhÃ´ng há»— trá»£ sáº¯p xáº¿p Ä‘á»™ng**. Pháº£i thÃªm má»‡nh Ä‘á» `ORDER BY` thá»§ cÃ´ng.
  * **KhÃ´ng cÃ³ tÃ­nh nÄƒng tá»± Ä‘iá»u chá»‰nh SQL** giá»¯a cÃ¡c RDBMS khÃ¡c nhau.
# Truy váº¥n sá»­ dá»¥ng Entity manager
Tuyá»‡t vá»i\! DÆ°á»›i Ä‘Ã¢y lÃ  tÃ i liá»‡u Ä‘áº§y Ä‘á»§ vÃ  chi tiáº¿t vá» cÃ¡c phÆ°Æ¡ng phÃ¡p **Truy váº¥n sá»­ dá»¥ng Entity Manager** trong JPA, bao gá»“m cÃ¡c vÃ­ dá»¥ minh há»a cho tá»«ng phÆ°Æ¡ng phÃ¡p.

# ğŸ” CÃ¡c PhÆ°Æ¡ng PhÃ¡p Truy Váº¥n Sá»­ Dá»¥ng EntityManager

**`EntityManager`** cung cáº¥p ba cÆ¡ cháº¿ chÃ­nh Ä‘á»ƒ tÆ°Æ¡ng tÃ¡c vÃ  truy xuáº¥t dá»¯ liá»‡u tá»« cÆ¡ sá»Ÿ dá»¯ liá»‡u:

1.  **JPQL (Java Persistence Query Language)**: Truy váº¥n HÆ°á»›ng Äá»‘i tÆ°á»£ng, Ä‘á»™c láº­p vá»›i cÆ¡ sá»Ÿ dá»¯ liá»‡u.
2.  **Native SQL**: Truy váº¥n SQL thuáº§n, táº­n dá»¥ng cÃº phÃ¡p Ä‘áº·c trÆ°ng cá»§a DBMS.
3.  **Criteria API**: XÃ¢y dá»±ng truy váº¥n an toÃ n vá» kiá»ƒu (type-safe) báº±ng mÃ£ Java.

-----

## 1\. JPQL (Java Persistence Query Language)

JPQL lÃ  ngÃ´n ngá»¯ truy váº¥n tiÃªu chuáº©n cá»§a JPA, Ä‘Æ°á»£c thiáº¿t káº¿ Ä‘á»ƒ hoáº¡t Ä‘á»™ng trÃªn **cÃ¡c thá»±c thá»ƒ** vÃ  **cÃ¡c má»‘i quan há»‡** cá»§a chÃºng, chá»© khÃ´ng pháº£i trÃªn cÃ¡c báº£ng vÃ  cá»™t cÆ¡ sá»Ÿ dá»¯ liá»‡u.

### A. JPQL Äá»™ng (Dynamic JPQL)

Báº¡n xÃ¢y dá»±ng cÃ¢u lá»‡nh JPQL dÆ°á»›i dáº¡ng chuá»—i vÃ  sá»­ dá»¥ng `em.createQuery()`.

| PhÆ°Æ¡ng thá»©c | MÃ´ táº£ |
| :--- | :--- |
| **`em.createQuery(jpqlString)`** | Táº¡o má»™t thá»ƒ hiá»‡n `Query` (hoáº·c `TypedQuery`). |
| **`query.setParameter(name, value)`** | Thiáº¿t láº­p giÃ¡ trá»‹ cho tham sá»‘ Ä‘áº·t tÃªn (vÃ­ dá»¥: `:name`). |
| **`query.setParameter(position, value)`** | Thiáº¿t láº­p giÃ¡ trá»‹ cho tham sá»‘ vá»‹ trÃ­ (vÃ­ dá»¥: `?1`). |
| **`query.getResultList()`** | Thá»±c thi truy váº¥n vÃ  tráº£ vá» danh sÃ¡ch káº¿t quáº£. |
| **`query.getSingleResult()`** | Thá»±c thi truy váº¥n vÃ  tráº£ vá» má»™t káº¿t quáº£ duy nháº¥t (bÃ¡o lá»—i náº¿u khÃ´ng cÃ³ hoáº·c cÃ³ nhiá»u hÆ¡n má»™t). |

#### VÃ­ dá»¥ tham kháº£o (Dynamic JPQL)

Giáº£ sá»­ cÃ³ thá»±c thá»ƒ `Product` cÃ³ thuá»™c tÃ­nh `price`.

```java
// 1. Äá»‹nh nghÄ©a JPQL
String jpql = "SELECT p FROM Product p WHERE p.price > :minPrice ORDER BY p.name";

// 2. Táº¡o TypedQuery (Æ°u tiÃªn dÃ¹ng TypedQuery Ä‘á»ƒ an toÃ n kiá»ƒu)
TypedQuery<Product> query = em.createQuery(jpql, Product.class);

// 3. Thiáº¿t láº­p tham sá»‘
query.setParameter("minPrice", 500.00);

// 4. Thá»±c thi
List<Product> expensiveProducts = query.getResultList();
```

### B. JPQL Äáº·t TÃªn (Named JPQL Query)

Truy váº¥n Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a dÆ°á»›i dáº¡ng annotation trÃªn lá»›p Entity. Äiá»u nÃ y giÃºp tÃ¡ch biá»‡t truy váº¥n khá»i mÃ£ logic vÃ  cho phÃ©p JPA Provider tá»‘i Æ°u hÃ³a trÆ°á»›c khi á»©ng dá»¥ng khá»Ÿi Ä‘á»™ng.

#### VÃ­ dá»¥ tham kháº£o (Named JPQL Query)

```java
// Trong lá»›p Product.java
@Entity
@NamedQuery(
    name = "Product.findByName",
    query = "SELECT p FROM Product p WHERE p.name = :name"
)
public class Product {
    // ...
}

// Trong EntityManager
TypedQuery<Product> query = em.createNamedQuery("Product.findByName", Product.class);
query.setParameter("name", "Laptop A");
Product p = query.getSingleResult();
```

-----

## 2\. Native SQL Queries

Native SQL cho phÃ©p báº¡n sá»­ dá»¥ng ngÃ´n ngá»¯ SQL thuáº§n mÃ  cÆ¡ sá»Ÿ dá»¯ liá»‡u Ä‘ang dÃ¹ng há»— trá»£.

### A. Truy Váº¥n Tráº£ vá» Entity

Sá»­ dá»¥ng `em.createNativeQuery(sqlString, Entity.class)` Ä‘á»ƒ Ã¡nh xáº¡ káº¿t quáº£ SQL thuáº§n vá» cÃ¡c Ä‘á»‘i tÆ°á»£ng Entity Ä‘Æ°á»£c quáº£n lÃ½.

#### VÃ­ dá»¥ tham kháº£o (Native SQL -\> Entity)

```java
// 1. SQL thuáº§n
String sql = "SELECT * FROM products p WHERE p.price > ?";

// 2. Táº¡o Query, chá»‰ Ä‘á»‹nh Product.class Ä‘á»ƒ Ã¡nh xáº¡ káº¿t quáº£
List<Product> results = em.createNativeQuery(sql, Product.class)
                            .setParameter(1, 1000.00) // Tham sá»‘ vá»‹ trÃ­
                            .getResultList();
```

### B. Truy Váº¥n Tráº£ vá» Dá»¯ liá»‡u VÃ´ hÆ°á»›ng (Scalar)

Náº¿u báº¡n cáº§n thá»±c hiá»‡n cÃ¡c truy váº¥n phá»©c táº¡p (vÃ­ dá»¥: `COUNT`, `SUM`, `JOIN` nhiá»u báº£ng khÃ´ng tÆ°Æ¡ng á»©ng vá»›i Entity) vÃ  chá»‰ cáº§n dá»¯ liá»‡u thÃ´.

#### VÃ­ dá»¥ tham kháº£o (Native SQL -\> Scalar)

```java
// SQL: Láº¥y tÃªn vÃ  giÃ¡ cá»§a sáº£n pháº©m
String sql = "SELECT name, price FROM products WHERE quantity > 10";

// Táº¡o Query (khÃ´ng chá»‰ Ä‘á»‹nh Entity.class)
List<Object[]> results = em.createNativeQuery(sql)
                             .getResultList();

// Xá»­ lÃ½ káº¿t quáº£: Má»—i pháº§n tá»­ trong List lÃ  má»™t máº£ng Object[]
for (Object[] row : results) {
    String name = (String) row[0];
    Double price = (Double) row[1];
    System.out.println("TÃªn: " + name + ", GiÃ¡: " + price);
}
```

-----

## 3\. Criteria API

Criteria API lÃ  má»™t cÃ¡ch tiáº¿p cáº­n **an toÃ n vá» kiá»ƒu (type-safe)** Ä‘á»ƒ xÃ¢y dá»±ng JPQL theo chÆ°Æ¡ng trÃ¬nh báº±ng cÃ¡ch sá»­ dá»¥ng cÃ¡c Ä‘á»‘i tÆ°á»£ng Java (thay vÃ¬ chuá»—i). PhÆ°Æ¡ng phÃ¡p nÃ y Ä‘áº·c biá»‡t há»¯u Ã­ch cho cÃ¡c truy váº¥n **Ä‘á»™ng (dynamic queries)**, nÆ¡i cÃ¡c má»‡nh Ä‘á» `WHERE` Ä‘Æ°á»£c xÃ¢y dá»±ng dá»±a trÃªn cÃ¡c Ä‘iá»u kiá»‡n tÃ¹y chá»n cá»§a ngÆ°á»i dÃ¹ng.

### CÃ¡c BÆ°á»›c Thá»±c Hiá»‡n CÆ¡ Báº£n

1.  **Láº¥y `CriteriaBuilder`**: Láº¥y Ä‘á»‘i tÆ°á»£ng Ä‘á»ƒ táº¡o cÃ¡c thÃ nh pháº§n truy váº¥n.
    ```java
    CriteriaBuilder cb = em.getCriteriaBuilder();
    ```
2.  **Táº¡o `CriteriaQuery`**: Äá»‘i tÆ°á»£ng truy váº¥n chÃ­nh, xÃ¡c Ä‘á»‹nh kiá»ƒu tráº£ vá».
    ```java
    CriteriaQuery<Product> cq = cb.createQuery(Product.class);
    ```
3.  **Äá»‹nh nghÄ©a `Root`**: TÆ°Æ¡ng Ä‘Æ°Æ¡ng vá»›i má»‡nh Ä‘á» `FROM`.
    ```java
    Root<Product> productRoot = cq.from(Product.class);
    ```
4.  **XÃ¢y dá»±ng Má»‡nh Ä‘á»**: Sá»­ dá»¥ng `CriteriaBuilder` Ä‘á»ƒ táº¡o `SELECT`, `WHERE`, `ORDER BY`, v.v.
    ```java
    cq.select(productRoot);
    ```
5.  **Thá»±c thi**: Táº¡o `TypedQuery` tá»« `CriteriaQuery` vÃ  cháº¡y.
    ```java
    TypedQuery<Product> query = em.createQuery(cq);
    List<Product> products = query.getResultList();
    ```

### VÃ­ dá»¥ Chi tiáº¿t (Criteria API cho Truy váº¥n Äá»™ng)

Truy váº¥n: TÃ¬m cÃ¡c sáº£n pháº©m cÃ³ giÃ¡ trong khoáº£ng **`[minPrice, maxPrice]`** VÃ€ tÃªn chá»©a **`keyword`**.

```java
import javax.persistence.criteria.*;

// Giáº£ sá»­ minPrice=100, maxPrice=500, keyword="Smart"

CriteriaBuilder cb = em.getCriteriaBuilder();
CriteriaQuery<Product> cq = cb.createQuery(Product.class);
Root<Product> productRoot = cq.from(Product.class);

// Táº¡o danh sÃ¡ch cÃ¡c Ä‘iá»u kiá»‡n (Predicate)
List<Predicate> predicates = new ArrayList<>();

// Äiá»u kiá»‡n 1: Price Between
if (minPrice != null && maxPrice != null) {
    Predicate priceRange = cb.between(productRoot.get("price"), minPrice, maxPrice);
    predicates.add(priceRange);
}

// Äiá»u kiá»‡n 2: Name Like (sá»­ dá»¥ng lower Ä‘á»ƒ khÃ´ng phÃ¢n biá»‡t chá»¯ hoa/thÆ°á»ng)
if (keyword != null && !keyword.isEmpty()) {
    String likePattern = "%" + keyword.toLowerCase() + "%";
    Predicate nameLike = cb.like(cb.lower(productRoot.get("name")), likePattern);
    predicates.add(nameLike);
}

// Káº¿t há»£p táº¥t cáº£ Ä‘iá»u kiá»‡n báº±ng AND
cq.where(cb.and(predicates.toArray(new Predicate[0])));

// Chá»n káº¿t quáº£
cq.select(productRoot);

// Thá»±c thi
TypedQuery<Product> query = em.createQuery(cq);
List<Product> filteredProducts = query.getResultList();
```

-----

## TÃ³m Táº¯t Æ¯u vÃ  NhÆ°á»£c Äiá»ƒm

| PhÆ°Æ¡ng PhÃ¡p | Æ¯u Ä‘iá»ƒm | NhÆ°á»£c Ä‘iá»ƒm | PhÃ¹ há»£p nháº¥t cho |
| :--- | :--- | :--- | :--- |
| **JPQL** | **Di Ä‘á»™ng (Portable)**, dá»… Ä‘á»c, hÆ°á»›ng Ä‘á»‘i tÆ°á»£ng. | CÃº phÃ¡p lÃ  chuá»—i (String), dá»… bá»‹ lá»—i cÃº phÃ¡p Run-time. | Truy váº¥n tÄ©nh (Static) vÃ  cá»‘ Ä‘á»‹nh. |
| **Native SQL** | **Linh hoáº¡t tá»‘i Ä‘a**, táº­n dá»¥ng cÃº phÃ¡p DBMS, hiá»‡u suáº¥t cao. | **KhÃ´ng di Ä‘á»™ng**, dá»… bá»‹ lá»—i náº¿u chuyá»ƒn Ä‘á»•i DBMS. | CÃ¡c truy váº¥n phá»©c táº¡p, tá»‘i Æ°u hÃ³a Ä‘áº·c thÃ¹, bÃ¡o cÃ¡o chi tiáº¿t. |
| **Criteria API** | **An toÃ n kiá»ƒu**, dá»… xÃ¢y dá»±ng **truy váº¥n Ä‘á»™ng** phá»©c táº¡p. | CÃº phÃ¡p dÃ i dÃ²ng hÆ¡n, khÃ³ Ä‘á»c hÆ¡n JPQL/SQL thuáº§n. | XÃ¢y dá»±ng cÃ¡c bá»™ lá»c tÃ¬m kiáº¿m Ä‘á»™ng (Search Filters). |
# BÃ i táº­p: HoÃ n thiá»‡n CRUD bÃ i táº­p buá»•i 3 (Ä‘áº§y Ä‘á»§ cÃ¡c quan há»‡, khuyáº¿n khÃ­ch Ã¡p dá»¥ng Ä‘a dáº¡ng 4 má»©c Ä‘á»™ truy váº¥n sá»­ dá»¥ng JPA ká»ƒ trÃªn).
`